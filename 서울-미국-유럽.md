## ğŸš€ í•˜ì´ë¸Œë¦¬ë“œ í´ëŸ¬ìŠ¤í„° êµ¬ì¶• ì‹¤ìŠµ ë‚´ìš© ì„¤ëª…

ë³¸ ì‹¤ìŠµì€ (ìƒí™©1) ì™¸ë¶€ ë…¸ì¶œ ì—†ë„ë¡ ì„œìš¸ ë³¸ì‚¬ì— ê´€ë¦¬ ì„œë²„ì™€, DBì„œë²„ë¥¼ ë‘ê³  2) ì‚¬ê³ ë¥¼ ëŒ€ë¹„í•˜ê³  ê° ëŒ€ë¥™ì˜ ë¡œë“œë°¸ëŸ°ì‹±ì„ ìœ„í•´ AWS ì›¹ì„œë²„ë¥¼ ê°ê° ì„œìš¸, ë¯¸êµ­, ìœ ëŸ½ì— 1ê°œì”© êµ¬ì¶•í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ë¥¼ ì´ë£¨ì–´ ì„œë¹„ìŠ¤í•˜ëŠ” ìƒí™©ì„ êµ¬ì¶•í•  ê²ƒì…ë‹ˆë‹¤. 

ì´ëŠ” **ì§€ë¦¬ì ìœ¼ë¡œ ë¶„ì‚°ëœ ì´ì¢…(ç•°ç¨®) ì¸í”„ë¼**ë¥¼ í†µí•©í•˜ì—¬ **ë‹¨ì¼í™”ëœ ìš´ì˜ í™˜ê²½**ì„ êµ¬ì¶•í•˜ëŠ” ì‹¤ë¬´ì ì¸ ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤. ìš°ë¦¬ëŠ” **ì˜¨í”„ë ˆë¯¸ìŠ¤(VirtualBox)** í™˜ê²½ì˜ í•µì‹¬ ì„œë¹„ìŠ¤(K8s Master, MySQL DB)ì™€ \*\*ë©€í‹° í´ë¼ìš°ë“œ(AWS 3ê°œ ë¦¬ì „)\*\*ì˜ ì»´í“¨íŒ… ìì›(K8s Worker)ì„ **í•˜ì´ë¸Œë¦¬ë“œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°**ë¡œ ë¬¶ì–´ ì„œë¹„ìŠ¤ ì—°ì†ì„±ê³¼ ê¸€ë¡œë²Œ í™•ì¥ì„±ì„ í™•ë³´í•˜ëŠ” ê³¼ì •ì„ ì‹¤ìŠµí•´ ë³´ê² ìŠµë‹ˆë‹¤. 
ì´ ê³¼ì •ì€ ë§¤ìš° ì „ë¬¸ì ì´ê³  ì‹¤ë¬´ì ì¸ ì‹¤ìŠµì…ë‹ˆë‹¤. í•˜ì§€ë§Œ, ê·¸ëŸ¼ì—ë„ ë¶ˆêµ¬í•˜ê³  ë³¸ì‚¬ ë°©í™”ë²½ ë“± ì—¬ëŸ¬ ë³´ì•ˆ, ê´€ì œì™€ ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì— ëŒ€í•œ ë§ì€ ì¶”ê°€ ì‚¬í•­ì´ ìƒëµëœ ê²ƒì…ë‹ˆë‹¤. 

### ì‹¤ìŠµì˜ í•µì‹¬ ëª©í‘œ

1.  **IaC ê¸°ë°˜ ì¸í”„ë¼ ìë™í™”:** **Terraform**ì„ ì‚¬ìš©í•˜ì—¬ ë³¸ì‚¬ì˜ **VirtualBox VM**ê³¼ AWSì˜ **VPC, EC2, NLB, S3** ë“± ëª¨ë“  ì¸í”„ë¼ ìì›ì„ ì½”ë“œë¡œ ì •ì˜í•˜ê³  ìƒì„±í•˜ëŠ” ë°©ë²•ì„ í•™ìŠµí•©ë‹ˆë‹¤.
2.  **ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë° ë³´ì•ˆ ì œì–´:** ë³¸ì‚¬ ë¼ìš°í„°ì— \*\*ì •ì  ê²½ë¡œ(Static Route)\*\*ì™€ **ACL**ì„ ì„¤ì •í•˜ì—¬, AWS í´ë¼ìš°ë“œ ë‚´ì˜ Worker ë…¸ë“œë“¤ì´ ë³¸ì‚¬ì˜ **K8s Master API**ì™€ **MySQL ë°ì´í„°ë² ì´ìŠ¤**ì— ì•ˆì „í•˜ê²Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ë° ë¼ìš°íŒ… í™˜ê²½ì„ êµ¬ì„±í•©ë‹ˆë‹¤.
3.  **êµ¬ì„± ê´€ë¦¬(Configuration Management) ìë™í™”:** **Ansible**ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ì„œë²„(VM/EC2)ì— **Docker/Containerd** ë° **Kubeadm**ì„ ì„¤ì¹˜í•˜ê³ , **MySQL DB**ë¥¼ êµ¬ì„±í•˜ë©°, ìµœì¢…ì ìœ¼ë¡œ **ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™” ë° Worker Join**ì„ ìë™í™”í•˜ì—¬ ì‹œìŠ¤í…œ êµ¬ì¶• ì‹œê°„ì„ íšê¸°ì ìœ¼ë¡œ ë‹¨ì¶•í•˜ëŠ” ì‹¤ì „ ê²½í—˜ì„ ìŒ“ìŠµë‹ˆë‹¤.
4.  **ê¸€ë¡œë²Œ ë¡œë“œ ë°¸ëŸ°ì‹± êµ¬í˜„:** AWSì˜ \*\*Route 53 GSLB (Global Server Load Balancing)\*\*ì™€ **NLB**ë¥¼ í™œìš©í•˜ì—¬, ì „ ì„¸ê³„ ì‚¬ìš©ì íŠ¸ë˜í”½ì„ ì§€ì—° ì‹œê°„(Latency) ê¸°ì¤€ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ì§€ì‚¬ì˜ Worker ë…¸ë“œë¡œ ë¶„ì‚°ì‹œí‚¤ëŠ” ê³ ê°€ìš©ì„± ì„œë¹„ìŠ¤ ì¸í”„ë¼ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤.

ì´ ì‹¤ìŠµì„ í†µí•´ ë¶„ì‚° ì‹œìŠ¤í…œì˜ **ì•ˆì •ì„±**, **ë³´ì•ˆì„±**, **í™•ì¥ì„±**ì„ ë†’ì´ëŠ” **DevOps ë° í´ë¼ìš°ë“œ ì•„í‚¤í…ì²˜ ì„¤ê³„ ì—­ëŸ‰**ì„ ìŠµë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.



### ğŸ“Œ ì‹¤ìŠµ í™˜ê²½ ê°œìš” ë° IP êµ¬ì„±

| êµ¬ë¶„ | ìœ„ì¹˜ | ì„œë²„ ì—­í•  | ì‚¬ì„¤ IP ì£¼ì†Œ | AWS VPC ëŒ€ì—­ |
| :---: | :---: | :---: | :---: | :---: |
| **On-Premises 1** | **íšŒì‚¬ ì‚¬ë‚´** | **K8s Master** (VirtualBox VM) | **192.168.1.100** | N/A |
| **On-Premises 2** | **íšŒì‚¬ ì‚¬ë‚´** | **MySQL DB Server** (VirtualBox VM) | **192.168.1.101** | N/A |
| **Cloud A** | **AWS ì„œìš¸** | K8s Worker & **S3 Storage** | 10.10.1.100 (ì˜ˆì‹œ) | **10.10.0.0/16** |
| **Cloud B** | **AWS ë¯¸ì£¼(ë²„ì§€ë‹ˆì•„)** | K8s Worker | 10.20.1.100 (ì˜ˆì‹œ) | **10.20.0.0/16** |
| **Cloud C** | **AWS ìœ ëŸ½(í”„ë‘í¬í‘¸ë¥´íŠ¸)** | K8s Worker | 10.30.1.100 (ì˜ˆì‹œ) | **10.30.0.0/16** |

-----

## 1\. ğŸ”‘ ë³´ì•ˆ í‚¤ ë° ë¯¼ê° ì •ë³´ ê´€ë¦¬ (í•„ìˆ˜)

**ì¤‘ìš”:** ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸, SSH í‚¤, **AWS ì•¡ì„¸ìŠ¤ í‚¤** ë“± ë¯¼ê° ì •ë³´ëŠ” ì½”ë“œì— ì§ì ‘ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ëŠ” **HashiCorp Vault**ì™€ ê°™ì€ ì „ìš© ë„êµ¬ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì›ì¹™ì…ë‹ˆë‹¤.

  * **ì‹¤ìŠµ ê´€ë¦¬ ë°©ì‹:** ë¹„ë°€ë²ˆí˜¸ ë° í‚¤ëŠ” ë³„ë„ì˜ **`.env` íŒŒì¼**ì— ë³´ê´€í•˜ê³ , ì´ íŒŒì¼ì€ **`.gitignore`ì— ë°˜ë“œì‹œ ë“±ë¡**í•˜ì—¬ Git ì €ì¥ì†Œì— í¬í•¨ë˜ì§€ ì•Šë„ë¡ ê´€ë¦¬í•©ë‹ˆë‹¤.

<!-- end list -->

```bash
# .env (ì‹¤ìŠµ í™˜ê²½ ë¯¼ê° ì •ë³´ ì˜ˆì‹œ)
export AWS_ACCESS_KEY_ID="AKIAxxxxxxxxxxxxxxx" 
export AWS_SECRET_ACCESS_KEY="wJalrXUxxxxxxxxxxxxxxx"
export MYSQL_ROOT_PASSWORD="YourSecureRootPassword!" 
export DB_USER_PASSWORD="WebAppUserSecurePassword!"
```

-----

## 2\. ğŸ› ï¸ ì „ì²´ ì‘ì—… ë‹¨ê³„ ìš”ì•½

| \# | ì‘ì—… ì˜ì—­ | ëŒ€ìƒ ì¥ë¹„/ì„œë¹„ìŠ¤ | ì£¼ìš” ì‘ì—… ë‚´ìš© | ë‹´ë‹¹ ë„êµ¬ |
| :---: | :---: | :---: | :---: | :---: |
| **1ë‹¨ê³„** | **ì¸í”„ë¼ ìì› ì •ì˜ ë° ìƒì„± (IaC)** | **VirtualBox**, **AWS (3 ë¦¬ì „)** | **S3 ë²„í‚· ìƒì„±** ë° **IAM ì—­í• ** ì •ì˜. Master/DB VM ë° AWS Worker ìì› ìƒì„±. | **Terraform** |
| **2ë‹¨ê³„** | **ë¼ìš°í„° ì„¤ì •** | **ë³¸ì‚¬ ë¼ìš°í„°** | **AWS VPC ëŒ€ì—­**($10.10.0.0/16$ ë“±)ìœ¼ë¡œ í–¥í•˜ëŠ” **ì •ì  ê²½ë¡œ(Static Route)** ë° **ACL** ì„¤ì •. | **Cisco IOS/CLI** |
| **3ë‹¨ê³„** | **ìš´ì˜ì²´ì œ ë° ê¸°ë³¸ ì„¤ì¹˜** | **ëª¨ë“  ì„œë²„ (5ëŒ€)** | **Docker/Containerd, Kubeadm** ì„¤ì¹˜, **S3 ì ‘ì† ë„êµ¬** ì„¤ì¹˜ ë° ì„¤ì •. **MySQL DB ì„¤ì¹˜** ë° ì´ˆê¸° ì„¤ì •. | **Terraform** (`local-exec`) + **Ansible** |
| **4ë‹¨ê³„** | **í´ëŸ¬ìŠ¤í„° êµ¬ì„± & Join** | **ëª¨ë“  ì„œë²„ (4ëŒ€)** | **Master ì´ˆê¸°í™”, CNI ì„¤ì¹˜, Worker Join** ëª…ë ¹ ì‹¤í–‰ ìë™í™”. | **Ansible** |
| **5ë‹¨ê³„** | **ë¡œë“œ ë°¸ëŸ°ì‹± ì¸í”„ë¼** | **AWS (3 ë¦¬ì „) & Route 53** | ë¦¬ì „ë³„ **NLB** ìƒì„± ë° **AWS Route 53 GSLB** ì„¤ì •. | **Terraform** |

-----

## 3\. ğŸ“ 1ë‹¨ê³„: ì¸í”„ë¼ ìì› ì •ì˜ ë° ìƒì„± (Terraform ì½”ë“œ)

### A. VirtualBox ë° AWS Provider ì„¤ì • (`main.tf` ì¼ë¶€)

AWS Providerì— \*\*ì„œìš¸ ë¦¬ì „(ap-northeast-2)\*\*ì„ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •í•˜ê³ , VirtualBox VM ìƒì„±ì„ ìœ„í•œ `local-exec` ì„¤ì •ì„ í¬í•¨í•©ë‹ˆë‹¤.

```terraform
# -----------------------------------------------------------------------------
# 1. Terraform ì„¤ì • ë° Provider ì •ì˜
# -----------------------------------------------------------------------------
terraform {
  required_providers {
    aws  = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    # VirtualBox VM ìƒì„±ì„ ìœ„í•œ ë¡œì»¬ ëª…ë ¹ì–´ ì‹¤í–‰ìš© Provider
    null = {
      source = "hashicorp/null"
      version = "~> 3.0"
    } 
  }
}

# AWS Provider ì •ì˜ (ë¦¬ì „ë³„ ë³„ì¹­ ì‚¬ìš©)
provider "aws" {
  alias  = "seoul"
  region = "ap-northeast-2"
}
provider "aws" {
  alias  = "virginia"
  region = "us-east-1"
}
provider "aws" {
  alias  = "frankfurt"
  region = "eu-central-1"
}

# -----------------------------------------------------------------------------
# 2. On-Premise í™˜ê²½ ë³€ìˆ˜ ë° VirtualBox VM ì •ì˜
# -----------------------------------------------------------------------------
locals {
  k8s_master_ip  = "192.168.1.100"
  mysql_db_ip    = "192.168.1.101"
  onprem_cidr    = "192.168.1.0/24"
  ansible_user   = "ubuntu"
}

# VirtualBox VM ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (K8s Master ë° MySQL DB ì„œë²„ ìƒì„±)
resource "null_resource" "onprem_vbox_setup" {
  # scripts/create_vbox_vms.sh íŒŒì¼ì€ Ubuntu ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ VMì„ ìƒì„±í•˜ê³  
  # ì§€ì •ëœ ê³ ì • IPë¥¼ í• ë‹¹í•˜ëŠ” VBoxManage ëª…ë ¹ì–´ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
  provisioner "local-exec" {
    #command = "sh ./scripts/create_vbox_vms.sh ${local.k8s_master_ip} ${local.mysql_db_ip}" ë‘ ê°œ ë³€ìˆ˜ë¥¼ $1, $2ë¡œ ì „ë‹¬. ê°€ë…ì„± ë¹„ì¶”
    command = "K8S_MASTER_IP=${local.k8s_master_ip} MYSQL_DB_IP=${local.mysql_db_ip} sh ./scripts/create_vbox_vms.sh"
  }
}

# K8s Master ì„œë²„ ê°ì²´ (Ansible ì¸ë²¤í† ë¦¬ì—ì„œ ì°¸ì¡°í•  IP/ì‚¬ìš©ì ì •ë³´ ì €ì¥)
resource "null_resource" "k8s_master_onprem" {
  depends_on = [null_resource.onprem_vbox_setup]
  triggers = {
    ip_address = local.k8s_master_ip
    user = local.ansible_user
  }
}

# MySQL DB ì„œë²„ ê°ì²´ (Ansible ì¸ë²¤í† ë¦¬ì—ì„œ ì°¸ì¡°í•  IP/ì‚¬ìš©ì ì •ë³´ ì €ì¥)
resource "null_resource" "mysql_db_server" {
  depends_on = [null_resource.onprem_vbox_setup]
  triggers = {
    ip_address = local.mysql_db_ip
    user = local.ansible_user
  }
}

# -----------------------------------------------------------------------------
# 3. AWS ì„œìš¸ S3 ë²„í‚· ë° IAM ìì› ì •ì˜ (ì¤‘ì•™ ê³µìœ  ìŠ¤í† ë¦¬ì§€)
# -----------------------------------------------------------------------------

# S3 ë²„í‚· ìƒì„± (ì„œìš¸ ë¦¬ì „)
resource "aws_s3_bucket" "shared_storage" {
  provider = aws.seoul
  bucket = "hybrid-k8s-shared-log-storage-2025" 
  acl    = "private"
}

# S3 ì ‘ê·¼ì„ ìœ„í•œ IAM ì‚¬ìš©ì ìƒì„± (On-prem VM ë° AWS EC2ì—ì„œ ì‚¬ìš©)
resource "aws_iam_user" "s3_access_user" {
  name = "k8s-s3-file-access"
}

# S3 Read/Write ì ‘ê·¼ ì •ì±… ì •ì˜
resource "aws_iam_policy" "s3_read_write" {
  name        = "S3ReadWritePolicy"
  description = "Allows read and write access to the shared S3 bucket"
  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Effect = "Allow",
        Action = ["s3:PutObject", "s3:GetObject", "s3:ListBucket", "s3:DeleteObject"],
        Resource = [
          aws_s3_bucket.shared_storage.arn,
          "${aws_s3_bucket.shared_storage.arn}/*",
        ],
      },
    ],
  })
}

# IAM ì‚¬ìš©ìì—ê²Œ ì •ì±… ì—°ê²°
resource "aws_iam_user_policy_attachment" "s3_attach" {
  user       = aws_iam_user.s3_access_user.name
  policy_arn = aws_iam_policy.s3_read_write.arn
}

# S3 ì ‘ê·¼ì„ ìœ„í•œ Access Key ë° Secret Key ìƒì„± (Ansibleì—ì„œ ì‚¬ìš©)
resource "aws_iam_access_key" "s3_key" {
  user = aws_iam_user.s3_access_user.name
}

# -----------------------------------------------------------------------------
# 4. AWS Regional Worker Infrastructure Module í˜¸ì¶œ
# -----------------------------------------------------------------------------
# ê° ë¦¬ì „ì— VPC, Subnet, EC2 Worker ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ëª¨ë“ˆì„ í˜¸ì¶œí•©ë‹ˆë‹¤.

module "seoul_infra" {
  source    = "./modules/regional_setup"
  providers = { aws = aws.seoul }
  region_name = "Seoul"
  vpc_cidr    = "10.10.0.0/16"
  onprem_cidr = local.onprem_cidr
}

module "virginia_infra" {
  source    = "./modules/regional_setup"
  providers = { aws = aws.virginia }
  region_name = "Virginia"
  vpc_cidr    = "10.20.0.0/16"
  onprem_cidr = local.onprem_cidr
}

module "frankfurt_infra" {
  source    = "./modules/regional_setup"
  providers = { aws = aws.frankfurt }
  region_name = "Frankfurt"
  vpc_cidr    = "10.30.0.0/16"
  onprem_cidr = local.onprem_cidr
}

# -----------------------------------------------------------------------------
# 5. ê¸€ë¡œë²Œ ë¡œë“œ ë°¸ëŸ°ì‹± (Route 53) ì •ì˜
# -----------------------------------------------------------------------------
# ì‹¤ì œ NLB ë° Target Group ì •ì˜ëŠ” ê° ì§€ì—­ ì¸í”„ë¼ ëª¨ë“ˆ ë‚´ë¶€ ë˜ëŠ” ë³„ë„ load_balancer.tfì— ì •ì˜ë©ë‹ˆë‹¤.
# ì—¬ê¸°ì„œëŠ” Route 53ì„ ì‚¬ìš©í•˜ì—¬ GSLBë¥¼ êµ¬í˜„í•˜ëŠ” ì˜ˆì‹œë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.

resource "aws_route53_record" "global_k8s_access" {
  # YOUR_HOSTED_ZONE_IDë¥¼ ì‹¤ì œ Route 53 Hosted Zone IDë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤.
  zone_id = "YOUR_HOSTED_ZONE_ID" 
  name    = "app.yourcompany.com"
  type    = "A"
  ttl     = 60

  # ì„œìš¸ ë¦¬ì „ ë¼ìš°íŒ… ì •ì±…
  alias {
    name                   = module.seoul_infra.nlb_dns_name 
    zone_id                = module.seoul_infra.nlb_zone_id
    evaluate_target_health = true
  }
  latency_routing_policy {
    region = "ap-northeast-2"
  }
  set_identifier = "seoul-traffic"

  # ë²„ì§€ë‹ˆì•„ ë¦¬ì „ ë¼ìš°íŒ… ì •ì±…
  alias {
    name                   = module.virginia_infra.nlb_dns_name 
    zone_id                = module.virginia_infra.nlb_zone_id
    evaluate_target_health = true
  }
  latency_routing_policy {
    region = "us-east-1"
  }
  set_identifier = "virginia-traffic"

  # í”„ë‘í¬í‘¸ë¥´íŠ¸ ë¦¬ì „ ë¼ìš°íŒ… ì •ì±…
  alias {
    name                   = module.frankfurt_infra.nlb_dns_name 
    zone_id                = module.frankfurt_infra.nlb_zone_id
    evaluate_target_health = true
  }
  latency_routing_policy {
    region = "eu-central-1"
  }
  set_identifier = "frankfurt-traffic"
}
```

-----

## 4\. ğŸ“ 2ë‹¨ê³„: ë³¸ì‚¬ ë¼ìš°í„° ì„¤ì • ì½”ë“œ

AWS VPCì™€ ë³¸ì‚¬ LAN($192.168.1.0/24$) ê°„ì˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë° ë³´ì•ˆ í†µë¡œë¥¼ í™•ë³´í•©ë‹ˆë‹¤.

### âš™ï¸ ì„œìš¸ ë³¸ì‚¬ ë¼ìš°í„° ì„¤ì • (Cisco IOS ê¸°ë°˜)

```bash
! Router_SEOUL (ì„œìš¸ ë³¸ì‚¬ ë¼ìš°í„°) ì„¤ì •

configure terminal
hostname Router_SEOUL

! AWS VPC ëŒ€ì—­ìœ¼ë¡œì˜ ì •ì  ê²½ë¡œ ì„¤ì • (Next-Hop IP ì£¼ì†Œ: VPN/Direct Connect ìƒëŒ€í¸ ê²Œì´íŠ¸ì›¨ì´ IP ì˜ˆì‹œ: 100.1.1.1)
ip route 10.10.0.0 255.255.0.0 100.1.1.1
ip route 10.20.0.0 255.255.0.0 100.1.1.1
ip route 10.30.0.0 255.255.0.0 100.1.1.1

! ACL ì„¤ì •: K8s í†µì‹  ë° MySQL DB ì ‘ê·¼ í—ˆìš©
ip access-list extended K8S_HYBRID_ACL
! 1. K8s í†µì‹  í—ˆìš©
permit tcp 10.0.0.0 0.255.255.255 host 192.168.1.100 eq 6443 
permit tcp 10.0.0.0 0.255.255.255 192.168.1.0 0.0.0.255 range 10250 10257
permit tcp 10.0.0.0 0.255.255.255 192.168.1.0 0.0.0.255 range 30000 32767

! 2. AWS Worker (K8s Pods)ì—ì„œ MySQL DBë¡œì˜ ì ‘ê·¼ í—ˆìš© (3306 í¬íŠ¸)
permit tcp 10.0.0.0 0.255.255.255 host 192.168.1.101 eq 3306 

! ì¸í„°í˜ì´ìŠ¤ì— ACL ì ìš© (VPN/Direct Connect ì¸í„°í˜ì´ìŠ¤)
interface GigabitEthernet0/0
 ip access-group K8S_HYBRID_ACL in
 
end
write memory
```

-----

## 5\. ğŸ“ 3ë‹¨ê³„ & 4ë‹¨ê³„: OS ë° í´ëŸ¬ìŠ¤í„° êµ¬ì„± (Ansible ì½”ë“œ)

### A. ğŸ¡ Ansible ì¸ë²¤í† ë¦¬ (`inventory.ini` êµ¬ì„±)

```ini
# inventory.ini

[kube_master]
k8s_master_onprem ansible_host=192.168.1.100 ansible_user=ubuntu

[kube_workers]
k8s_worker_seoul ansible_host=52.78.1.100 ansible_user=ubuntu
k8s_worker_us ansible_host=3.21.10.100 ansible_user=ubuntu
k8s_worker_eu ansible_host=18.157.5.100 ansible_user=ubuntu

[mysql_server]
mysql_db_server ansible_host=192.168.1.101 ansible_user=ubuntu

[k8s_cluster:children]
kube_master
kube_workers
```

### B. ğŸ’¾ S3 ì ‘ì† ë° MySQL ì„¤ì • Playbook (`setup.yaml`)

**ëª¨ë“  ì„œë²„**ì— **AWS CLI**ë¥¼ ì„¤ì¹˜í•˜ê³ , S3 ì ‘ê·¼ì„ ìœ„í•œ **ìê²© ì¦ëª…**ì„ ì„¤ì •í•©ë‹ˆë‹¤. ì´í›„ MySQL ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤.

```yaml
# setup.yaml (MySQL ë° S3 ì ‘ê·¼ ì„¤ì •)

# ------------------------------------------
# Play 1: ëª¨ë“  ì„œë²„ì— AWS CLI ì„¤ì¹˜ ë° S3 ìê²© ì¦ëª… ì„¤ì • (3ë‹¨ê³„ S3 ì ‘ê·¼ ì¤€ë¹„)
# ------------------------------------------
- name: 3. Install AWS CLI and Configure S3 Access
  hosts: k8s_cluster, mysql_server
  become: yes
  vars:
    aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
    aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
    aws_region: "ap-northeast-2" # S3 ë²„í‚· ë¦¬ì „

  tasks:
    - name: Install AWS CLI (using pip/apt as needed for Ubuntu)
      apt:
        name: awscli
        state: present
        update_cache: yes
    
    - name: Configure AWS credentials for root user
      blockinfile:
        path: /root/.aws/credentials
        create: yes
        block: |
          [default]
          aws_access_key_id = {{ aws_access_key }}
          aws_secret_access_key = {{ aws_secret_key }}
          region = {{ aws_region }}

    - name: Configure AWS config for root user
      blockinfile:
        path: /root/.aws/config
        create: yes
        block: |
          [default]
          region = {{ aws_region }}
          output = json

# ------------------------------------------
# Play 2: MySQL Database Server ì„¤ì¹˜ ë° ì‚¬ìš©ì ì„¤ì • (3ë‹¨ê³„ DB êµ¬ì¶•)
# ------------------------------------------
- name: 3. Setup MySQL Database Server and Users
  hosts: mysql_server
  become: yes
  vars:
    db_root_password: "{{ lookup('env', 'MYSQL_ROOT_PASSWORD') }}" 
    db_user_password: "{{ lookup('env', 'DB_USER_PASSWORD') }}"
    db_name: "my_webapp_db"
  
  tasks:
    - name: Install MySQL Server
      apt:
        name: mysql-server
        state: present
        update_cache: yes
    # ... (MySQL ì‚¬ìš©ì, DB ìƒì„± ë° ì›ê²© ì ‘ì† í—ˆìš© ì„¤ì • ì‘ì—…ì€ ì´ì „ ë‹µë³€ê³¼ ë™ì¼) ...

# ------------------------------------------
# Play 3: K8s í´ëŸ¬ìŠ¤í„° í™˜ê²½ ì¤€ë¹„ ë° êµ¬ì„± (3, 4ë‹¨ê³„)
# ------------------------------------------

# K8s ì„¤ì¹˜ ë° í™˜ê²½ ì¤€ë¹„
- name: 3. Install Kubeadm and Docker
  hosts: k8s_cluster
  become: yes
  # ... (Docker/Kubeadm ì„¤ì¹˜ ë° Swap ë¹„í™œì„±í™” ì‘ì—…ì€ ì´ì „ ë‹µë³€ì˜ Play 1ê³¼ ë™ì¼) ...

# Master ì´ˆê¸°í™” ë° CNI ì„¤ì¹˜
- name: 4. Initialize K8s Master and Install CNI
  hosts: kube_master
  become: yes
  # ... (Master ì´ˆê¸°í™” ë° Join ëª…ë ¹ì–´ íšë“ ì‘ì—…ì€ ì´ì „ ë‹µë³€ì˜ Play 2ì™€ ë™ì¼) ...

# Worker Join ì‹¤í–‰
- name: 4. Join Workers to the Cluster
  hosts: kube_workers
  become: yes
  # ... (Worker Join ì‹¤í–‰ ì‘ì—…ì€ ì´ì „ ë‹µë³€ì˜ Play 3ì™€ ë™ì¼) ...
```

## 6\. ğŸš€ ìµœì¢… ì‹¤í–‰ ìˆœì„œ ë° ë§ˆë¬´ë¦¬

ì´ ê³¼ì •ì„ í†µí•´ S3ë¥¼ ì¤‘ì•™ íŒŒì¼ ì €ì¥ì†Œë¡œ í™œìš©í•˜ëŠ” **ì™„ë²½í•˜ê²Œ ìë™í™”ëœ í•˜ì´ë¸Œë¦¬ë“œ ì‹œìŠ¤í…œ**ì´ êµ¬ì¶•ë©ë‹ˆë‹¤.

1.  **Terraform ì‹¤í–‰:** AWS ì¸í”„ë¼, VirtualBox VM, **S3 ë²„í‚· ë° IAM ìì›** ìƒì„±
    ```bash
    $ terraform init
    $ terraform apply
    ```
2.  **ë¼ìš°í„° ì„¤ì •:** ìˆ˜ë™ìœ¼ë¡œ ë³¸ì‚¬ ë¼ìš°í„°ì— **ACL** ë° **ì •ì  ê²½ë¡œ** ìŠ¤í¬ë¦½íŠ¸ ì ìš©.
3.  **í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ:** `.env` íŒŒì¼ì˜ ë¹„ë°€ë²ˆí˜¸ ë° í‚¤ë¥¼ ë¡œë“œ
    ```bash
    $ source .env 
    ```
4.  **Ansible ì‹¤í–‰:** S3 ì ‘ê·¼ ì„¤ì •, MySQL ì„¤ì¹˜, K8s í´ëŸ¬ìŠ¤í„° êµ¬ì„±
    ```bash
    $ ansible-playbook -i inventory.ini setup.yaml site.yaml
    ```
5.  **í´ëŸ¬ìŠ¤í„° ë° S3 í™•ì¸:**
    ```bash
    $ kubectl get nodes
    $ aws s3 ls s3://hybrid-k8s-shared-log-storage-2025/ --profile default 
    ```
    ëª¨ë“  ë…¸ë“œê°€ **Ready** ìƒíƒœì´ê³  S3 ë²„í‚·ì— ì •ìƒì ìœ¼ë¡œ ì ‘ê·¼ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
