## ğŸŒ í•˜ì´ë¸Œë¦¬ë“œ í´ëŸ¬ìŠ¤í„° êµ¬ì¶• ì‹¤ìŠµ ì•ˆë‚´ (ìµœì¢… ë¬¸ì„œ)

ì´ ë¬¸ì„œëŠ” **VirtualBox ê¸°ë°˜ ë³¸ì‚¬ ì„œë²„**ì™€ **AWS ë©€í‹° í´ë¼ìš°ë“œ Worker ì„œë²„**ë¥¼ í†µí•©í•˜ì—¬ **í•˜ì´ë¸Œë¦¬ë“œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°**ë¥¼ êµ¬ì¶•í•˜ëŠ” ìµœì¢… ì‹¤ìŠµ ì•ˆë‚´ì„œì…ë‹ˆë‹¤. ëª¨ë“  ì¸í”„ë¼(VM/EC2/NLB) êµ¬ì„±ì€ \*\*Terraform (IaC)\*\*ìœ¼ë¡œ ìë™í™”í•˜ê³ , í´ëŸ¬ìŠ¤í„° êµ¬ì„± ë° DB ì„¤ì •ì€ **Ansible**ë¡œ ì™„ë£Œí•©ë‹ˆë‹¤.

### ğŸ“Œ ì‹¤ìŠµ í™˜ê²½ ê°œìš” ë° IP êµ¬ì„±

| êµ¬ë¶„ | ìœ„ì¹˜ | ì„œë²„ ì—­í•  | ì‚¬ì„¤ IP ì£¼ì†Œ | AWS VPC ëŒ€ì—­ |
| :---: | :---: | :---: | :---: | :---: |
| **On-Premises 1** | **íšŒì‚¬ ì‚¬ë‚´** | **K8s Master** (VirtualBox VM) | **192.168.1.100** | N/A |
| **On-Premises 2** | **íšŒì‚¬ ì‚¬ë‚´** | **MySQL DB Server** (VirtualBox VM) | **192.168.1.101** | N/A |
| **Cloud A** | **AWS ì„œìš¸** | K8s Worker | 10.10.1.100 (ì˜ˆì‹œ) | **10.10.0.0/16** |
| **Cloud B** | **AWS ë¯¸ì£¼(ë²„ì§€ë‹ˆì•„)** | K8s Worker | 10.20.1.100 (ì˜ˆì‹œ) | **10.20.0.0/16** |
| **Cloud C** | **AWS ìœ ëŸ½(í”„ë‘í¬í‘¸ë¥´íŠ¸)** | K8s Worker | 10.30.1.100 (ì˜ˆì‹œ) | **10.30.0.0/16** |

-----

## 1\. ğŸ”‘ ë³´ì•ˆ í‚¤ ë° ë¯¼ê° ì •ë³´ ê´€ë¦¬ (í•„ìˆ˜)

**ì‹¤ì „ íŒ:** ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸, SSH í‚¤ ë“± ë¯¼ê° ì •ë³´ëŠ” **ì ˆëŒ€ë¡œ ì½”ë“œì— ì§ì ‘ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**. ì•„ë˜ì™€ ê°™ì´ **í™˜ê²½ ë³€ìˆ˜**ë‚˜ **HashiCorp Vault**ë¥¼ í†µí•´ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤.

  * **ê´€ë¦¬ ë°©ì‹:** ë¹„ë°€ë²ˆí˜¸ëŠ” ë³„ë„ì˜ **`.env` íŒŒì¼**ì— ë³´ê´€í•˜ê³ , ì´ íŒŒì¼ì€ **`.gitignore`ì— ë°˜ë“œì‹œ ë“±ë¡**í•˜ì—¬ Git ì €ì¥ì†Œì— í¬í•¨ë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.

<!-- end list -->

```bash
# .env (ì‹¤ìŠµ í™˜ê²½ ë¯¼ê° ì •ë³´ ì˜ˆì‹œ)
export MYSQL_ROOT_PASSWORD="YourSecureRootPassword!" 
export DB_USER_PASSWORD="WebAppUserSecurePassword!"
```

-----

## 2\. ğŸ› ï¸ ì „ì²´ ì‘ì—… ë‹¨ê³„ ìš”ì•½

| \# | ì‘ì—… ì˜ì—­ | ëŒ€ìƒ ì¥ë¹„/ì„œë¹„ìŠ¤ | ì£¼ìš” ì‘ì—… ë‚´ìš© | ë‹´ë‹¹ ë„êµ¬ |
| :---: | :---: | :---: | :---: | :---: |
| **1ë‹¨ê³„** | **ì¸í”„ë¼ ìì› ì •ì˜ ë° ìƒì„± (IaC)** | **VirtualBox**, **AWS (3 ë¦¬ì „)** | **Master VM, DB VM** ì •ì˜ ë° **AWS VPC/EC2 Worker** ìì› ì •ì˜ ë° ìƒì„±. | **Terraform** |
| **2ë‹¨ê³„** | **ë¼ìš°í„° ì„¤ì •** | **ë³¸ì‚¬ ë¼ìš°í„°** | **AWS VPC ëŒ€ì—­**($10.10.0.0/16$ ë“±)ìœ¼ë¡œ í–¥í•˜ëŠ” **ì •ì  ê²½ë¡œ(Static Route)** ë° **ACL** ì„¤ì •. | **Cisco IOS/CLI** |
| **3ë‹¨ê³„** | **ìš´ì˜ì²´ì œ ë° ê¸°ë³¸ ì„¤ì¹˜** | **ëª¨ë“  ì„œë²„ (5ëŒ€)** | **Docker/Containerd, Kubeadm** ì„¤ì¹˜, **Swap ë¹„í™œì„±í™”**. **MySQL DB ì„¤ì¹˜** ë° ì´ˆê¸° ì„¤ì •. | **Terraform** (`local-exec`) + **Ansible** |
| **4ë‹¨ê³„** | **í´ëŸ¬ìŠ¤í„° êµ¬ì„± & Join** | **ëª¨ë“  ì„œë²„ (4ëŒ€)** | **Master ì´ˆê¸°í™”, CNI ì„¤ì¹˜, Worker Join** ëª…ë ¹ ì‹¤í–‰ ìë™í™”. | **Ansible** |
| **5ë‹¨ê³„** | **ë¡œë“œ ë°¸ëŸ°ì‹± ì¸í”„ë¼** | **AWS (3 ë¦¬ì „) & Route 53** | ë¦¬ì „ë³„ **NLB** ìƒì„± ë° **AWS Route 53 GSLB** ì„¤ì •. | **Terraform** |

-----

## 3\. ğŸ“ 1ë‹¨ê³„: ì¸í”„ë¼ ìì› ì •ì˜ (Terraform ì½”ë“œ)

### A. VirtualBox ì„œë²„ ì¸í”„ë¼ ì •ì˜ (`main.tf` ì¼ë¶€)

VirtualBox VM ê´€ë¦¬ëŠ” \*\*`local-exec`\*\*ê³¼ ì‰˜ ìŠ¤í¬ë¦½íŠ¸(`create_vbox_vms.sh`)ë¥¼ ê²°í•©í•˜ì—¬ ìë™í™”í•©ë‹ˆë‹¤.

```terraform
# main.tf (VirtualBox ë° AWS í†µí•© ì„¤ì •)

terraform {
  required_providers {
    aws  = { source = "hashicorp/aws" }
    null = { source = "hashicorp/null" } 
  }
}

# AWS Provider ì„¤ì • (seoul, virginia, frankfurt alias) - ìƒëµ

# ------------------------------------------
# 1. On-Premise Master ë° DB ì„œë²„ ì •ì˜ (VirtualBox)
# ------------------------------------------

locals {
  k8s_master_ip  = "192.168.1.100"
  mysql_db_ip    = "192.168.1.101"
  onprem_cidr    = "192.168.1.0/24"
  ansible_user   = "ubuntu"
}

# VirtualBox VM ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (IACë¥¼ ìœ„í•œ ê°œë…ì  ì •ì˜)
resource "null_resource" "onprem_vbox_setup" {
  provisioner "local-exec" {
    # ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” K8s Master (192.168.1.100)ì™€ MySQL DB (192.168.1.101) VMì„ ìƒì„±í•©ë‹ˆë‹¤.
    command = "sh ./scripts/create_vbox_vms.sh ${local.k8s_master_ip} ${local.mysql_db_ip}"
  }
}

# K8s Master ì„œë²„ ê°ì²´ (Ansible ì¸ë²¤í† ë¦¬ì—ì„œ ì°¸ì¡°)
resource "null_resource" "k8s_master_onprem" {
  depends_on = [null_resource.onprem_vbox_setup]
  triggers = {
    ip_address = local.k8s_master_ip
    user = local.ansible_user
  }
}

# MySQL DB ì„œë²„ ê°ì²´ (Ansible ì¸ë²¤í† ë¦¬ì—ì„œ ì°¸ì¡°)
resource "null_resource" "mysql_db_server" {
  depends_on = [null_resource.onprem_vbox_setup]
  triggers = {
    ip_address = local.mysql_db_ip
    user = local.ansible_user
  }
}
# ------------------------------------------
# 2. AWS Worker ì¸í”„ë¼ ì •ì˜ ë° 5. ë¡œë“œ ë°¸ëŸ°ì‹± ì¸í”„ë¼ ì •ì˜ëŠ” ìƒëµ
#    (ì´ì „ ë‹µë³€ì—ì„œ ì œì‹œëœ ëª¨ë“ˆ ë° AWS ë¦¬ì†ŒìŠ¤ ì •ì˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.)
```

-----

## 4\. ğŸ“ 2ë‹¨ê³„: ë³¸ì‚¬ ë¼ìš°í„° ì„¤ì • ì½”ë“œ

AWS VPCì™€ ë³¸ì‚¬ LAN($192.168.1.0/24$) ê°„ì˜ **VPN/Direct Connect** ì—°ê²°ì´ **ë¼ìš°í„° ì„¤ì •**ì„ í†µí•´ ì´ë£¨ì–´ì¡Œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤. **AWS VPCì˜ IP ëŒ€ì—­ì€ ë¼ìš°í„° ì„¤ì •ì„ í†µí•´ ì‚¬ì„¤ë§($192.168.1.x$)ìœ¼ë¡œ ë¼ìš°íŒ…ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.**

### âš™ï¸ ì„œìš¸ ë³¸ì‚¬ ë¼ìš°í„° ì„¤ì • (Cisco IOS ê¸°ë°˜)

```bash
! Router_SEOUL (ì„œìš¸ ë³¸ì‚¬ ë¼ìš°í„°) ì„¤ì •

configure terminal
hostname Router_SEOUL

! AWS VPC ëŒ€ì—­ìœ¼ë¡œì˜ ì •ì  ê²½ë¡œ ì„¤ì •
! Next-Hop IP ì£¼ì†Œ: VPN/Direct Connect ìƒëŒ€í¸ ê²Œì´íŠ¸ì›¨ì´ IP (ì˜ˆì‹œ: 100.1.1.1)
ip route 10.10.0.0 255.255.0.0 100.1.1.1
ip route 10.20.0.0 255.255.0.0 100.1.1.1
ip route 10.30.0.0 255.255.0.0 100.1.1.1

! ACL ì„¤ì •: K8s í†µì‹  ë° MySQL DB ì ‘ê·¼ í—ˆìš©
ip access-list extended K8S_HYBRID_ACL
! 1. K8s í†µì‹  í—ˆìš©
permit tcp 10.0.0.0 0.255.255.255 host 192.168.1.100 eq 6443  ! AWS -> Master API
permit tcp 10.0.0.0 0.255.255.255 192.168.1.0 0.0.0.255 range 10250 10257 ! Kubelet/Proxy
permit tcp 10.0.0.0 0.255.255.255 192.168.1.0 0.0.0.255 range 30000 32767 ! NodePort Range

! 2. AWS Worker (K8s Pods)ì—ì„œ MySQL DBë¡œì˜ ì ‘ê·¼ í—ˆìš© (3306 í¬íŠ¸)
permit tcp 10.0.0.0 0.255.255.255 host 192.168.1.101 eq 3306 ! AWS -> MySQL DB

! ì¸í„°í˜ì´ìŠ¤ì— ACL ì ìš© (VPN/Direct Connect ì¸í„°í˜ì´ìŠ¤)
interface GigabitEthernet0/0
 ip access-group K8S_HYBRID_ACL in
 
end
write memory
```

-----

## 5\. ğŸ“ 3ë‹¨ê³„ & 4ë‹¨ê³„: OS ë° í´ëŸ¬ìŠ¤í„° êµ¬ì„± (Ansible ì½”ë“œ)

### A. ğŸ¡ Ansible ì¸ë²¤í† ë¦¬ (`inventory.ini` êµ¬ì„±)

AWS EC2 Workerì˜ **ê³µì¸ IP**ëŠ” ë¼ìš°í„° ì„¤ì •(ë¼ìš°íŒ…)ê³¼ ì¶©ëŒí•˜ì§€ ì•ŠëŠ” **ì ì ˆí•œ ì˜ˆì‹œ**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ë²¤í† ë¦¬ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤. (ì˜ˆ: AWS ì„œìš¸ Worker ê³µì¸ IP: 52.78.1.100)

```ini
# inventory.ini

[kube_master]
k8s_master_onprem ansible_host=192.168.1.100 ansible_user=ubuntu

[kube_workers]
k8s_worker_seoul ansible_host=52.78.1.100 ansible_user=ubuntu
k8s_worker_us ansible_host=3.21.10.100 ansible_user=ubuntu
k8s_worker_eu ansible_host=18.157.5.100 ansible_user=ubuntu

[mysql_server]
mysql_db_server ansible_host=192.168.1.101 ansible_user=ubuntu

[k8s_cluster:children]
kube_master
kube_workers
```

### B. ğŸ’¾ MySQL ì„¤ì • Playbook (`mysql_setup.yaml`)

MySQL ì„œë²„ì— ì ‘ì†í•˜ì—¬ ì„¤ì¹˜í•˜ê³ , AWS VPC ëŒ€ì—­($10.x.x.x$)ì„ í¬í•¨í•œ ëª¨ë“  K8s Podsì˜ ì ‘ê·¼ì„ í—ˆìš©í•©ë‹ˆë‹¤.

```yaml
# mysql_setup.yaml (MySQL ì„œë²„ì—ë§Œ ì ìš©)

- name: Setup MySQL Database Server and Users
  hosts: mysql_server
  become: yes
  vars:
    db_root_password: "{{ lookup('env', 'MYSQL_ROOT_PASSWORD') }}" 
    db_user_password: "{{ lookup('env', 'DB_USER_PASSWORD') }}"
    db_name: "my_webapp_db"

  tasks:
    - name: Install MySQL Server
      apt:
        name: mysql-server
        state: present
        update_cache: yes
    # ... (MySQL ì‚¬ìš©ì ë° DB ìƒì„± task ìƒëµ - ì´ì „ ë‹µë³€ ë‚´ìš©ê³¼ ë™ì¼) ...
    
    - name: Create WebApp User and Grant Privileges (for K8s Pods)
      mysql_user:
        name: "webuser"
        password: "{{ db_user_password }}"
        host: "{{ item }}" # K8s Podsê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ëŒ€ì—­ í—ˆìš©
        priv: "{{ db_name }}.*:ALL"
        state: present
        login_user: root
        login_password: "{{ db_root_password }}"
      loop:
        - 10.10.0.0/16
        - 10.20.0.0/16
        - 10.30.0.0/16
        - 192.168.1.0/24 # On-Premise ë‚´ë¶€ë§
        
    - name: Allow Remote Connections (Bind to 0.0.0.0)
      lineinfile:
        path: /etc/mysql/mysql.conf.d/mysqld.cnf
        regexp: '^bind-address'
        line: 'bind-address = 0.0.0.0'
        backup: yes
      notify: Restart MySQL

  handlers:
    - name: Restart MySQL
      service:
        name: mysql
        state: restarted
```

### C. ğŸ³ K8s í´ëŸ¬ìŠ¤í„° êµ¬ì„± Playbook (`site.yaml`)

K8s Master/Worker ê³µí†µ ì„¤ì¹˜, Master ì´ˆê¸°í™”, Worker Joinì„ ë‹´ë‹¹í•˜ëŠ” í”Œë ˆì´ë¶ì…ë‹ˆë‹¤.

```yaml
# site.yaml (K8s ì„¤ì¹˜ ë° êµ¬ì„±)

# Play 1: ëª¨ë“  ë…¸ë“œì— Docker/Kubeadm ì„¤ì¹˜ (3ë‹¨ê³„ K8s í™˜ê²½ ì¤€ë¹„)
- name: 3. Install Kubeadm and Docker
  hosts: k8s_cluster
  # ... (ì„¤ì¹˜ ì‘ì—…ì€ ì´ì „ ë‹µë³€ì˜ Play 1ê³¼ ë™ì¼) ...

# Play 2: Master ì´ˆê¸°í™” ë° CNI ì„¤ì¹˜ (4ë‹¨ê³„)
- name: 4. Initialize K8s Master and Install CNI
  hosts: kube_master
  # ... (Master ì´ˆê¸°í™” ë° Join ëª…ë ¹ì–´ íšë“ ì‘ì—…ì€ ì´ì „ ë‹µë³€ì˜ Play 2ì™€ ë™ì¼) ...

# Play 3: Worker ë…¸ë“œ í´ëŸ¬ìŠ¤í„° Join (4ë‹¨ê³„)
- name: 4. Join Workers to the Cluster
  hosts: kube_workers
  # ... (Worker Join ì‹¤í–‰ ì‘ì—…ì€ ì´ì „ ë‹µë³€ì˜ Play 3ì™€ ë™ì¼) ...
```

-----

## 6\. ğŸš€ ìµœì¢… ì‹¤í–‰ ìˆœì„œ ë° ë§ˆë¬´ë¦¬

ì´ ê³¼ì •ì„ í†µí•´ ì¸í”„ë¼ êµ¬ì¶•ë¶€í„° í´ëŸ¬ìŠ¤í„° êµ¬ì„±ê¹Œì§€ **ì™„ë²½í•˜ê²Œ IaCë¡œ ê´€ë¦¬ë˜ëŠ” í•˜ì´ë¸Œë¦¬ë“œ ì‹œìŠ¤í…œ**ì´ êµ¬ì¶•ë©ë‹ˆë‹¤.

1.  **Terraform ì‹¤í–‰:** AWS ì¸í”„ë¼ ë° VirtualBox VM ìƒì„±
    ```bash
    $ terraform init
    $ terraform apply
    ```
2.  **ë¼ìš°í„° ì„¤ì •:** ìˆ˜ë™ìœ¼ë¡œ ë³¸ì‚¬ ë¼ìš°í„°ì— **ACL** ë° **ì •ì  ê²½ë¡œ** ìŠ¤í¬ë¦½íŠ¸ ì ìš©.
3.  **í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ:** `.env` íŒŒì¼ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¡œë“œ
    ```bash
    $ source .env 
    ```
4.  **Ansible ì‹¤í–‰:** MySQL ì„¤ì¹˜ ë° K8s í´ëŸ¬ìŠ¤í„° êµ¬ì„±
    ```bash
    $ ansible-playbook -i inventory.ini mysql_setup.yaml
    $ ansible-playbook -i inventory.ini site.yaml
    ```
5.  **í´ëŸ¬ìŠ¤í„° í™•ì¸:**
    ```bash
    $ kubectl get nodes
    ```
    ì´ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ, **On-Prem Master**ì™€ **3ê°œì˜ AWS Worker** ë…¸ë“œê°€ ëª¨ë‘ **Ready** ìƒíƒœì—¬ì•¼ í•©ë‹ˆë‹¤.
