## ğŸ› ï¸ í•˜ì´ë¸Œë¦¬ë“œ í´ëŸ¬ìŠ¤í„° êµ¬ì¶• ë‹¨ê³„ë³„ ì‘ì—… í†µí•© ìš”ì•½



ì´ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” **VMware vSphere** í™˜ê²½ì„ ê°€ì •í•˜ì—¬ ë³¸ì‚¬ ì„œë²„ë¥¼ **Terraform**ìœ¼ë¡œ ì •ì˜í•˜ê³ , **Ansible**ì„ ì‚¬ìš©í•˜ì—¬ K8s ì„¤ì¹˜ ë° Join ëª…ë ¹ì„ ìë™í™”í•˜ëŠ” ê°€ì¥ **ì „ë¬¸ì ì¸ ë°©ì‹**ì„ ì±„íƒí•©ë‹ˆë‹¤.

### ğŸ“Œ ìµœì¢… ì‘ì—… íë¦„ ë° ë„êµ¬

| \# | ì‘ì—… ì˜ì—­ | ëŒ€ìƒ ì¥ë¹„/ì„œë¹„ìŠ¤ | ì£¼ìš” ì‘ì—… ë‚´ìš© | ë‹´ë‹¹ ë„êµ¬ |
| :---: | :---: | :---: | :---: | :---: |
| **1ë‹¨ê³„** | **ì¸í”„ë¼ ì •ì˜ (IaC)** | **VMware vSphere, AWS (3 ë¦¬ì „)** | **ë³¸ì‚¬ Master VM**, **AWS Worker EC2 (3ëŒ€)** ë° **VPC/ë„¤íŠ¸ì›Œí¬** ìì› ì •ì˜. | **Terraform (vSphere, AWS)** |
| **2ë‹¨ê³„** | **ë¼ìš°í„° ì„¤ì •** | **ë³¸ì‚¬ ë¼ìš°í„°** | \*\*AWS VPC ëŒ€ì—­($10.10.0.0/16$ ë“±)\*\*ìœ¼ë¡œ í–¥í•˜ëŠ” **ì •ì  ê²½ë¡œ(Static Route)** ë° **ACL** ì„¤ì •. (VPN/Direct Connect í™˜ê²½ ê°€ì •) | **Cisco IOS/CLI** |
| **3ë‹¨ê³„** | **ìš´ì˜ì²´ì œ êµ¬ì„± & ì„¤ì¹˜** | **ëª¨ë“  ì„œë²„ (4ëŒ€)** | **Docker/Containerd, Kubeadm** ì„¤ì¹˜, **Swap ë¹„í™œì„±í™”.** | **Terraform** (`user_data`) + **Ansible** |
| **4ë‹¨ê³„** | **í´ëŸ¬ìŠ¤í„° êµ¬ì„± & Join** | **ëª¨ë“  ì„œë²„ (4ëŒ€)** | **Master ì´ˆê¸°í™”, CNI ì„¤ì¹˜, Worker Join** ëª…ë ¹ ì‹¤í–‰ì„ **ìë™í™”**. | **Ansible** |
| **5ë‹¨ê³„** | **ë¡œë“œ ë°¸ëŸ°ì‹± ì¸í”„ë¼** | **AWS (3 ë¦¬ì „) & Route 53** | ë¦¬ì „ë³„ **NLB/ALB** ìƒì„±, **AWS Route 53 GSLB** ì„¤ì •. | **Terraform (AWS)** |

-----

## 1\. ğŸ“ 1ë‹¨ê³„: ì¸í”„ë¼ ì •ì˜ (Terraform ì½”ë“œ)

### A. ë³¸ì‚¬ ì„œë²„ ì •ì˜ (VMware vSphere ê°€ì •)

VMware vCenterì— ì ‘ì†í•˜ì—¬ K8s Master ì—­í• ì„ ìˆ˜í–‰í•  VMì„ ì •ì˜í•©ë‹ˆë‹¤.

```terraform
# main.tf (VMware Provider ì„¤ì • ë¶€ë¶„)
terraform {
  required_providers {
    aws = { source = "hashicorp/aws" }
    vsphere = { source = "hashicorp/vsphere" }
  }
}

provider "vsphere" {
  user           = var.vsphere_user
  password       = var.vsphere_password
  vsphere_server = var.vsphere_server
  allow_unverified_ssl = true
}

# ------------------------------------------
# 1. ë³¸ì‚¬ K8s Master VM ì •ì˜ (VMware vSphere)
# ------------------------------------------
data "vsphere_datacenter" "dc" { name = "Datacenter-A" }
data "vsphere_resource_pool" "pool" {
  name          = "Cluster-A/Resources"
  datacenter_id = data.vsphere_datacenter.dc.id
}
data "vsphere_datastore" "datastore" {
  name          = "Datastore-Prod"
  datacenter_id = data.vsphere_datacenter.dc.id
}
data "vsphere_network" "network" {
  name          = "Prod-LAN"
  datacenter_id = data.vsphere_datacenter.dc.id
}

resource "vsphere_virtual_machine" "k8s_master" {
  name             = "K8s-Master-OnPrem"
  resource_pool_id = data.vsphere_resource_pool.pool.id
  datastore_id     = data.vsphere_datastore.datastore.id
  num_cpus         = 4
  memory           = 8192
  guest_id         = "ubuntu64Guest"
  scsi_type        = "lsilogic"

  # NIC ì„¤ì • (ë³¸ì‚¬ ë‚´ë¶€ë§: 192.168.1.100/24 ê³ ì • IP ê°€ì •)
  network_interface {
    network_id = data.vsphere_network.network.id
    adapter_type = "e1000"
  }
  disk {
    label = "disk0"
    size  = 100
    eagerly_scrub = false
    thin_provisioned = true
  }
  
  # 3ë‹¨ê³„: OS ë‚´ë¶€ ì„¤ì • (Cloud-init ëŒ€ì²´)
  clone {
    template_uuid = "YOUR_UBUNTU_TEMPLATE_UUID" # Ubuntu VM í…œí”Œë¦¿ UUID
  }

  # VMì— SSH í‚¤ ë° ì´ˆê¸° ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ì „ë‹¬ (Ansibleì„ ìœ„í•´ SSH ì„¤ì • í•„ìˆ˜)
  # (ì´í•˜ ìƒëµ - vsphere providerì˜ user_dataëŠ” ë³µì¡í•˜ì—¬ Ansibleë¡œ ëŒ€ì²´ ê¶Œì¥)
}
```

### B. AWS Worker ì¸í”„ë¼ ì •ì˜ (`main.tf` í†µí•©)

ì´ì „ ë‹µë³€ì˜ AWS EC2, VPC, NLB, Route 53 ì„¤ì •ì„ ëª¨ë‘ `main.tf`ì— í†µí•©í•©ë‹ˆë‹¤. (ì½”ë“œê°€ ê¸¸ì–´ì§€ë¯€ë¡œ ëª¨ë“ˆ íŒŒì¼ ë‚´ë¶€ëŠ” ì´ì „ ë‹µë³€ê³¼ ë™ì¼í•˜ë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.)

```terraform
# main.tf (AWS ë¦¬ì†ŒìŠ¤ ì •ì˜ ë¶€ë¶„ - í†µí•©)

# ... (Provider ì„¤ì • ìƒëµ) ...

# ------------------------------------------
# 2. AWS Worker ì¸í”„ë¼ ì •ì˜ (VPC, EC2, SG)
# ------------------------------------------
module "seoul_infra" {
  source    = "./modules/regional_setup"
  providers = { aws = aws.seoul }
  # ... (ë³€ìˆ˜ ì„¤ì • ìƒëµ) ...
}
# (module "virginia_infra" ë° "frankfurt_infra" í˜¸ì¶œ ìƒëµ)

# ------------------------------------------
# 5. ë¡œë“œ ë°¸ëŸ°ì‹± ì¸í”„ë¼ ì •ì˜
# ------------------------------------------

# ë¦¬ì „ë³„ NLB ì •ì˜
resource "aws_lb" "seoul_nlb" {
  provider = aws.seoul
  # ... (NLB ì„¤ì • ë° Target Group, Attachment ì •ì˜ ìƒëµ) ...
  # Target ID: module.seoul_infra.instance_id ì‚¬ìš©
}
# (ë¯¸ì£¼ ë° ìœ ëŸ½ NLB ì •ì˜ ìƒëµ)

# Route 53 GSLB ì •ì˜
resource "aws_route53_record" "global_k8s_access" {
  # ... (GSLB ì„¤ì • ìƒëµ) ...
  # Alias Name: aws_lb.seoul_nlb.dns_name ì‚¬ìš©
}
```

-----

## 2\. ğŸ“ 2ë‹¨ê³„: ë³¸ì‚¬ ë¼ìš°í„° ì„¤ì • ì½”ë“œ

### âš™ï¸ ì„œìš¸ ë³¸ì‚¬ ë¼ìš°í„° ì„¤ì • (Cisco IOS ê¸°ë°˜)

ë³¸ì‚¬ ë¼ìš°í„°ê°€ AWSì˜ ì„¸ VPC ëŒ€ì—­ìœ¼ë¡œ íŠ¸ë˜í”½ì„ ì •í™•íˆ ë¼ìš°íŒ…í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤. (AWS VPCì™€ ë³¸ì‚¬ ê°„ VPN ë˜ëŠ” Direct Connect ì—°ê²°ì´ `GigabitEthernet0/0` ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ì—°ê²°ë˜ì—ˆë‹¤ê³  ê°€ì •)

```bash
! Router_SEOUL (ì„œìš¸ ë³¸ì‚¬ ë¼ìš°í„°) ì„¤ì •

configure terminal
hostname Router_SEOUL

! AWS VPC ëŒ€ì—­ìœ¼ë¡œì˜ ì •ì  ê²½ë¡œ ì„¤ì •
! ë‹¤ìŒ í™‰(Next-Hop)ì€ VPN í„°ë„ì˜ ìƒëŒ€í¸ ê²Œì´íŠ¸ì›¨ì´ IP ì£¼ì†Œì…ë‹ˆë‹¤. (ê°€ìƒ IP: 100.1.1.1)
ip route 10.10.0.0 255.255.0.0 100.1.1.1
ip route 10.20.0.0 255.255.0.0 100.1.1.1
ip route 10.30.0.0 255.255.0.0 100.1.1.1

! ACL ì„¤ì •: K8s í†µì‹ ì— í•„ìš”í•œ í¬íŠ¸ í—ˆìš© (6443, 10250 ë“±)
ip access-list extended K8S_HYBRID_ACL
 permit tcp 10.0.0.0 0.255.255.255 host 192.168.1.100 eq 6443  ! AWS -> Master API
 permit tcp 10.0.0.0 0.255.255.255 192.168.1.0 0.0.0.255 eq 10250  ! AWS <-> OnPrem Kubelet
 permit tcp 10.0.0.0 0.255.255.255 192.168.1.0 0.0.0.255 eq 30000 32767 ! NodePort Range
! (CNI í†µì‹ , ETCD í†µì‹  ë“±ì— í•„ìš”í•œ í¬íŠ¸ ì¶”ê°€ í•„ìš”)

interface GigabitEthernet0/0
 ip access-group K8S_HYBRID_ACL in
 
end
write memory
```

-----

## 3\. ğŸ“ 3ë‹¨ê³„ & 4ë‹¨ê³„: ìš´ì˜ì²´ì œ êµ¬ì„± ë° í´ëŸ¬ìŠ¤í„° êµ¬ì„± (Ansible ì½”ë“œ)

Ansibleì€ ì´ë¯¸ Terraformìœ¼ë¡œ ìƒì„±ëœ VM ë° EC2ì— ì ‘ì†í•˜ì—¬ K8s ì„¤ì¹˜ ë° í´ëŸ¬ìŠ¤í„° Join ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

### A. ğŸ¡ Ansible ì¸ë²¤í† ë¦¬ (`inventory.ini`)

```ini
# inventory.ini

[kube_master]
k8s_master_onprem ansible_host=192.168.1.100 ansible_user=ubuntu

[kube_workers]
k8s_worker_seoul ansible_host=[ì„œìš¸ EC2 ê³µì¸IP] ansible_user=ubuntu
k8s_worker_us ansible_host=[ë¯¸êµ­ EC2 ê³µì¸IP] ansible_user=ubuntu
k8s_worker_eu ansible_host=[ìœ ëŸ½ EC2 ê³µì¸IP] ansible_user=ubuntu

[k8s_cluster:children]
kube_master
kube_workers
```

### B. ğŸ³ Ansible í”Œë ˆì´ë¶ (`site.yaml`)

ì´ í”Œë ˆì´ë¶ì€ ëª¨ë“  ë…¸ë“œì— K8së¥¼ ì„¤ì¹˜í•˜ê³ , Master ì´ˆê¸°í™” í›„ Workerë¥¼ Join ì‹œí‚µë‹ˆë‹¤.

```yaml
# site.yaml

---
# ------------------------------------------
# Play 1: ëª¨ë“  ë…¸ë“œì— Docker/Kubeadm ì„¤ì¹˜ (3ë‹¨ê³„ ìë™í™”)
# ------------------------------------------
- name: 3. Install Kubeadm and Docker
  hosts: k8s_cluster
  become: yes
  tasks:
    - name: Disable swap
      shell: |
        swapoff -a
        sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

    - name: Install required packages
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - apt-transport-https
        - ca-certificates
        - curl
        - gnupg
        - lsb-release

    - name: Install Containerd (Docker runtime)
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
        apt update
        apt install -y containerd.io

    - name: Install Kubeadm, Kubelet, Kubectl
      apt:
        name: kubelet={{ kube_version }}, kubeadm={{ kube_version }}, kubectl={{ kube_version }}
        state: present
        update_cache: yes
      vars:
        kube_version: "1.28.0-00" # ì›í•˜ëŠ” K8s ë²„ì „ ì§€ì •

# ------------------------------------------
# Play 2: Master ì´ˆê¸°í™” ë° CNI ì„¤ì¹˜ (4ë‹¨ê³„)
# ------------------------------------------
- name: 4. Initialize K8s Master and Install CNI
  hosts: kube_master
  become: yes
  tasks:
    - name: Initialize Kubernetes cluster
      shell: |
        kubeadm init --control-plane-endpoint "{{ hostvars['k8s_master_onprem']['ansible_host'] }}:6443" --pod-network-cidr="172.16.0.0/16" --upload-certs
      register: kubeadm_init_result

    - name: Set up kubeconfig for root and user
      shell: |
        mkdir -p $HOME/.kube
        cp /etc/kubernetes/admin.conf $HOME/.kube/config
        chown $(id -u):$(id -g) $HOME/.kube/config
        
    - name: Install Calico CNI
      shell: kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml
      
    - name: Get Join Command
      shell: kubeadm token create --print-join-command
      register: join_command

    - name: Store Join Command for Workers
      set_fact:
        worker_join_command: "{{ join_command.stdout }}"

# ------------------------------------------
# Play 3: Worker ë…¸ë“œ í´ëŸ¬ìŠ¤í„° Join (4ë‹¨ê³„)
# ------------------------------------------
- name: 4. Join Workers to the Cluster
  hosts: kube_workers
  become: yes
  tasks:
    - name: Execute join command
      shell: "{{ hostvars['k8s_master_onprem']['worker_join_command'] }}"
      args:
        warn: no
```

**ì‹¤í–‰ ìˆœì„œ:**

1.  **Terraform Apply:** `terraform init` -\> `terraform apply` (AWS ì¸í”„ë¼, ë³¸ì‚¬ VM ìƒì„±)
2.  **ë¼ìš°í„° ì„¤ì •:** ìˆ˜ë™ìœ¼ë¡œ Cisco IOSì— ìœ„ `Router_SEOUL` ìŠ¤í¬ë¦½íŠ¸ ì ìš©.
3.  **Ansible ì‹¤í–‰:** `ansible-playbook -i inventory.ini site.yaml` ì‹¤í–‰ (K8s ì„¤ì¹˜ ë° í´ëŸ¬ìŠ¤í„° í†µí•©).

ì´ ê³¼ì •ì„ í†µí•´ **ì¸í”„ë¼ë¶€í„° í´ëŸ¬ìŠ¤í„° êµ¬ì„±**ê¹Œì§€ **IaC ê¸°ë°˜ì˜ ìë™í™”ëœ ë¶„ì‚° ì‹œìŠ¤í…œ êµ¬ì¶•**ì´ ì™„ë£Œë©ë‹ˆë‹¤.



---

<br>


## ğŸ’» ë³¸ì‚¬ ë§ˆìŠ¤í„° ì„œë²„(VirtualBox) ë° MySQL ë°ì´í„°ë² ì´ìŠ¤ í†µí•© Terraform ì½”ë“œ

ê¸°ì¡´ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ **ë³¸ì‚¬ K8s Master ì„œë²„**ì˜ ì¸í”„ë¼ êµ¬ì¶• ëŒ€ìƒì„ **VMware vSphere**ì—ì„œ **VirtualBox**ë¡œ ë³€ê²½í•˜ê³ , ì¶”ê°€ë¡œ **ë³¸ì‚¬ ë‚´ë¶€ì— MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„**ë¥¼ êµ¬ì¶•í•˜ì—¬ ê° ì§€ì‚¬ì˜ \*\*ì›¹ ì„œë²„(K8s íŒŒë“œ)\*\*ê°€ ì—°ê²°ë  ìˆ˜ ìˆë„ë¡ Terraform ì½”ë“œë¥¼ ì—…ë°ì´íŠ¸í•˜ê² ìŠµë‹ˆë‹¤.

ì´ ì‘ì—…ì€ **HashiCorpì˜ Vagrantì™€ ì—°ê³„**í•˜ê±°ë‚˜ **`local-exec` í”„ë¡œë¹„ì €ë„ˆ**ë¥¼ ì‚¬ìš©í•˜ì—¬ VirtualBox VMì„ ì œì–´í•´ì•¼ í•˜ë¯€ë¡œ, ë³µì¡í•˜ì§€ë§Œ **ì‹¤ìŠµ í™˜ê²½ì— ì í•©í•œ ë°©ì‹**ì…ë‹ˆë‹¤.

### ğŸ“Œ ì„¤ê³„ ë³€ê²½ ë° ë³´ì•ˆ ì•ˆë‚´

| êµ¬ë¶„ | ìœ„ì¹˜ | ì„œë²„ ì—­í•  | ì‚¬ì„¤ IP ì£¼ì†Œ |
| :---: | :---: | :---: | :---: |
| **On-Premises 1** | **íšŒì‚¬ ì‚¬ë‚´** | **K8s Master** (VirtualBox VM) | **192.168.1.100** |
| **On-Premises 2** | **íšŒì‚¬ ì‚¬ë‚´** | **MySQL DB Server** (VirtualBox VM) | **192.168.1.101** |
| **Cloud (3ê³³)** | **AWS (ì„œìš¸, ë¯¸ì£¼, ìœ ëŸ½)** | K8s Worker | 10.10.x.x / 10.20.x.x / 10.30.x.x |

-----

## ğŸ”’ ë³´ì•ˆ í‚¤ ë° ë¯¼ê° ì •ë³´ ê´€ë¦¬ ì•ˆë‚´

**ì‹¤ì œ ìš´ì˜ í™˜ê²½**ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸, API í‚¤, SSH ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì€ **ë¯¼ê° ì •ë³´**ëŠ” ì ˆëŒ€ë¡œ Terraform ì½”ë“œë‚˜ Git ì €ì¥ì†Œì— í‰ë¬¸ìœ¼ë¡œ ì €ì¥í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.

  * **ê¶Œì¥ ë°©ì‹:** ë¯¼ê° ì •ë³´ëŠ” **HashiCorp Vault**, **AWS Secrets Manager**, **Azure Key Vault**ì™€ ê°™ì€ ì „ìš© \*\*ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ ì†”ë£¨ì…˜(Secret Management Tool)\*\*ì— ì €ì¥í•˜ê³ , Terraformì€ ì´ ë„êµ¬ì™€ ì—°ë™í•˜ì—¬ í•´ë‹¹ ê°’ì„ ì½ì–´ì™€ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
  * **ì‹¤ìŠµ í™˜ê²½ì—ì„œì˜ ëŒ€ì•ˆ:** Terraformì˜ \*\*`variable`\*\*ì„ ì‚¬ìš©í•˜ê³ , ì´ ë³€ìˆ˜ ê°’ì„ **`.tfvars` íŒŒì¼**ì´ë‚˜ **í™˜ê²½ ë³€ìˆ˜**ë¡œ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤. **`.tfvars` íŒŒì¼ì€ `.gitignore`ì— ë°˜ë“œì‹œ ë“±ë¡**í•˜ì—¬ ì €ì¥ì†Œì— ì˜¬ë¼ê°€ì§€ ì•Šë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.

**ì´ ì½”ë“œì—ì„œëŠ” ì˜ˆì‹œ ê°’ ëŒ€ì‹  ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©°, ì´ëŠ” ì™¸ë¶€ íŒŒì¼ì— ë³´ê´€í•´ì•¼ í•¨ì„ ëª…ì‹œí•©ë‹ˆë‹¤.**

-----

## 1\. âš™ï¸ Terraform ì„¤ì • íŒŒì¼ (VirtualBox í†µí•©)

VirtualBox í™˜ê²½ ì œì–´ë¥¼ ìœ„í•´ **`vagrant`** í”„ë¡œë°”ì´ë” ë˜ëŠ” **`local-exec`** í”„ë¡œë¹„ì €ë„ˆë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” **VirtualBox VMì„ ìƒì„±í•˜ê³  ì„¤ì •í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ `local-exec`ë¡œ í˜¸ì¶œ**í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

### `main.tf` (VirtualBox ë° AWS í†µí•©)

```terraform
terraform {
  required_providers {
    aws = { source = "hashicorp/aws" }
    null = { source = "hashicorp/null" } # local-exec ì‚¬ìš©ì„ ìœ„í•´ í•„ìš”
  }
}

# AWS Provider ì„¤ì •ì€ ì´ì „ ë‹µë³€ê³¼ ë™ì¼ (seoul, virginia, frankfurt alias)

# ------------------------------------------
# 1. On-Premise Master ë° DB ì„œë²„ ì •ì˜ (VirtualBox)
# ------------------------------------------

# Local Command ì‹¤í–‰ì„ ìœ„í•œ Null Resource ì‚¬ìš©
resource "null_resource" "onprem_setup" {
  # VirtualBox VM ìƒì„± ë° êµ¬ì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
  provisioner "local-exec" {
    command = "sh ./scripts/create_vbox_vms.sh"
    # VM ìƒì„± ë° ê³ ì • IP(192.168.1.100, 192.168.1.101) ì„¤ì • í¬í•¨
    # ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” Ubuntu Server ì´ë¯¸ì§€ë¥¼ importí•˜ê³  ë„¤íŠ¸ì›Œí¬ë¥¼ NAT Networkë¡œ ì„¤ì •í•´ì•¼ í•¨
  }
}

# K8s Master (192.168.1.100) ë° MySQL DB (192.168.1.101)ì˜ ì¡´ì¬ë¥¼ ì„ ì–¸
resource "null_resource" "k8s_master_onprem" {
  depends_on = [null_resource.onprem_setup]
  # Ansibleì—ì„œ ì‚¬ìš©í•  IP ì£¼ì†Œ
  triggers = {
    ip_address = "192.168.1.100"
  }
}
resource "null_resource" "mysql_db_server" {
  depends_on = [null_resource.onprem_setup]
  triggers = {
    ip_address = "192.168.1.101"
  }
}

# ------------------------------------------
# 2. AWS Worker ì¸í”„ë¼ ì •ì˜ (ì´ì „ ë‹µë³€ê³¼ ë™ì¼)
# ------------------------------------------
# ... module "seoul_infra", module "virginia_infra", module "frankfurt_infra" í˜¸ì¶œ ...

# ------------------------------------------
# 5. ë¡œë“œ ë°¸ëŸ°ì‹± ì¸í”„ë¼ ì •ì˜ (ì´ì „ ë‹µë³€ê³¼ ë™ì¼)
# ------------------------------------------
# ... aws_lb, aws_route53_record ì •ì˜ ...
```

-----

## 2\. ğŸ“ 2ë‹¨ê³„: ë³¸ì‚¬ ë¼ìš°í„° ì„¤ì • ì½”ë“œ

AWS VPC ëŒ€ì—­ê³¼ MySQL ì„œë²„($192.168.1.101$)ë¡œì˜ ì ‘ê·¼ì„ í—ˆìš©í•˜ë„ë¡ ACLì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

### âš™ï¸ ì„œìš¸ ë³¸ì‚¬ ë¼ìš°í„° ì„¤ì • (Cisco IOS ê¸°ë°˜)

```bash
! Router_SEOUL (ì„œìš¸ ë³¸ì‚¬ ë¼ìš°í„°) ì„¤ì •

configure terminal
hostname Router_SEOUL

! (AWS VPC ì •ì  ê²½ë¡œ ì„¤ì •ì€ ì´ì „ ë‹µë³€ê³¼ ë™ì¼)

! ACL ì„¤ì •: K8s í†µì‹  ë° MySQL DB ì ‘ê·¼ í—ˆìš©
ip access-list extended K8S_HYBRID_ACL
! 1. K8s API ë° Kubelet í†µì‹  í—ˆìš© (ì´ì „ ì„¤ì • í¬í•¨)
permit tcp 10.0.0.0 0.255.255.255 host 192.168.1.100 eq 6443  ! AWS -> Master API
permit tcp 10.0.0.0 0.255.255.255 192.168.1.0 0.0.0.255 eq 10250  ! AWS <-> OnPrem Kubelet
permit tcp 10.0.0.0 0.255.255.255 192.168.1.0 0.0.0.255 eq 30000 32767 ! NodePort Range

! 2. AWS Worker (ì›¹ ì„œë²„ íŒŒë“œ)ì—ì„œ MySQL DBë¡œì˜ ì ‘ê·¼ í—ˆìš© (3306 í¬íŠ¸)
permit tcp 10.0.0.0 0.255.255.255 host 192.168.1.101 eq 3306 ! AWS -> MySQL DB

! (ì´í•˜ ì¸í„°í˜ì´ìŠ¤ ì ìš© ë° ì €ì¥ ìƒëµ)
```

-----

## 3\. ğŸ“ 3ë‹¨ê³„ & 4ë‹¨ê³„: ìš´ì˜ì²´ì œ ë° í´ëŸ¬ìŠ¤í„° êµ¬ì„± (Ansible ì½”ë“œ ì—…ë°ì´íŠ¸)

Ansible í”Œë ˆì´ë¶ì— **MySQL ì„œë²„ ì„¤ì¹˜ ë° ì„¤ì •** ë‹¨ê³„ë¥¼ ì¶”ê°€í•˜ê³ , ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì • ì‹œ **DB ì—°ê²° ì •ë³´**ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„í•©ë‹ˆë‹¤.

### A. ğŸ¡ Ansible ì¸ë²¤í† ë¦¬ (`inventory.ini` ì—…ë°ì´íŠ¸)

```ini
# inventory.ini (MySQL ì„œë²„ ì¶”ê°€)

[kube_master]
k8s_master_onprem ansible_host=192.168.1.100 ansible_user=ubuntu

[kube_workers]
k8s_worker_seoul ansible_host=[ì„œìš¸ EC2 ê³µì¸IP] ansible_user=ubuntu
# ... (ë¯¸êµ­/ìœ ëŸ½ Worker ìƒëµ) ...

[mysql_server]
mysql_db_server ansible_host=192.168.1.101 ansible_user=ubuntu

[k8s_cluster:children]
kube_master
kube_workers
```

### B. ğŸ’¾ MySQL ì„¤ì • Playbook ì¶”ê°€ (`mysql_setup.yaml`)

MySQL ì„œë²„ì— ì ‘ì†í•˜ì—¬ ì„¤ì¹˜í•˜ê³ , ì›ê²©($10.x.x.x$ ëŒ€ì—­) ì ‘ì†ì„ í—ˆìš©í•©ë‹ˆë‹¤.

```yaml
# mysql_setup.yaml

- name: Setup MySQL Database Server
  hosts: mysql_server
  become: yes
  vars:
    db_root_password: "{{ lookup('env', 'MYSQL_ROOT_PASSWORD') }}" # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´
    db_name: "my_webapp_db"
    db_user: "webuser"
    db_user_password: "{{ lookup('env', 'DB_USER_PASSWORD') }}"

  tasks:
    - name: Install MySQL Server
      apt:
        name: mysql-server
        state: present
        update_cache: yes

    - name: Set MySQL root password
      mysql_user:
        name: root
        password: "{{ db_root_password }}"
        host: localhost
        login_user: root
        login_unix_socket: /var/run/mysqld/mysqld.sock # ì´ˆê¸° ì ‘ì† ë°©ì‹

    - name: Create WebApp Database
      mysql_db:
        name: "{{ db_name }}"
        state: present
        login_user: root
        login_password: "{{ db_root_password }}"

    - name: Create WebApp User and Grant Privileges (from K8s Pods)
      mysql_user:
        name: "{{ db_user }}"
        password: "{{ db_user_password }}"
        host: "{{ item }}" # AWS VPC ëŒ€ì—­ì—ì„œ ì ‘ì† í—ˆìš©
        priv: "{{ db_name }}.*:ALL/{{ item }}"
        state: present
        login_user: root
        login_password: "{{ db_root_password }}"
      loop:
        - 10.10.0.0/16 # ì„œìš¸ VPC ëŒ€ì—­
        - 10.20.0.0/16 # ë¯¸ì£¼ VPC ëŒ€ì—­
        - 10.30.0.0/16 # ìœ ëŸ½ VPC ëŒ€ì—­

    - name: Allow Remote Connections (Bind to 0.0.0.0)
      lineinfile:
        path: /etc/mysql/mysql.conf.d/mysqld.cnf
        regexp: '^bind-address'
        line: 'bind-address = 0.0.0.0'
        backup: yes
      notify: Restart MySQL

  handlers:
    - name: Restart MySQL
      service:
        name: mysql
        state: restarted
```

### C. ğŸ³ K8s Master ì´ˆê¸°í™” Playbook ì—…ë°ì´íŠ¸ (`site.yaml`)

Master ì´ˆê¸°í™” ë° Worker Join ìŠ¤í¬ë¦½íŠ¸ëŠ” ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤. Ansible Playbook ì‹¤í–‰ ì‹œ **`site.yaml` ì´ì „ì— `mysql_setup.yaml`ì„ ë¨¼ì € ì‹¤í–‰**í•´ì•¼ í•©ë‹ˆë‹¤.

-----

## 4\. ğŸ”‘ ë¯¼ê° ì •ë³´ ë³´ê´€ ë° ì‹¤í–‰

### A. í™˜ê²½ ë³€ìˆ˜ íŒŒì¼(`.env`) ìƒì„± (ë³´ì•ˆ ê´€ë¦¬)

DB ì ‘ì† ì •ë³´ëŠ” ë³„ë„ì˜ íŒŒì¼ì— ë³´ê´€í•˜ê³ , ì´ íŒŒì¼ì€ Gitì— ì ˆëŒ€ ì˜¬ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.

```bash
# .env (ë³´ì•ˆì„ ìœ„í•´ .gitignoreì— ì¶”ê°€)

# MySQL Root ë¹„ë°€ë²ˆí˜¸ (ë§¤ìš° ê°•ë ¥í•˜ê²Œ ì„¤ì •)
export MYSQL_ROOT_PASSWORD="SuperSecureRootPassword123!" 

# WebApp ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ (ê° K8s Podì—ì„œ ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸)
export DB_USER_PASSWORD="WebappUserSecurePassword456"

# K8s API ì„œë²„ ì£¼ì†Œ (On-Premise Master IP)
export K8S_MASTER_IP="192.168.1.100"
```

### B. ìµœì¢… ì‹¤í–‰ ëª…ë ¹ì–´

Ansibleì„ ì‹¤í–‰í•  ë•Œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ë¡œë“œí•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

```bash
# 1. Terraformìœ¼ë¡œ ì¸í”„ë¼ ìì›(AWS, VirtualBox VM) ìƒì„±
$ terraform init
$ terraform apply

# 2. í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
$ source .env

# 3. Ansible ì‹¤í–‰ (MySQL ì„¤ì • -> K8s ì„¤ì¹˜ ë° í´ëŸ¬ìŠ¤í„° Join)
$ ansible-playbook -i inventory.ini mysql_setup.yaml
$ ansible-playbook -i inventory.ini site.yaml
```
